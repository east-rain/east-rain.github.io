<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>개요 및 사용법 - 차곡차곡 쌓자</title> <link rel="shortcut icon" href="https://east-rain.github.io/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="https://east-rain.github.io/assets/css/just-the-docs.css"> <link rel="alternate" type="application/rss+xml" href="https://east-rain.github.io/feed.xml" title="차곡차곡 쌓자 Feed"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163902491-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', "UA-163902491-1"); </script> <script type="text/javascript" src="https://east-rain.github.io/assets/js/vendor/lunr.min.js" charset="utf-8"></script> <script type="text/javascript" src="https://east-rain.github.io/assets/js/just-the-docs.js" charset="utf-8"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="naver-site-verification" content="0ec4078b2caa70b3c1bd0053083cb7b3ed281f42" /> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>개요 및 사용법 | 차곡차곡 쌓자</title> <meta name="generator" content="Jekyll v3.8.6" /> <meta property="og:title" content="개요 및 사용법" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="차곡차곡 쌓아가는 기술블로그입니다. 되도록 정확한 자료만을 정리하려고 노력합니다." /> <meta property="og:description" content="차곡차곡 쌓아가는 기술블로그입니다. 되도록 정확한 자료만을 정리하려고 노력합니다." /> <link rel="canonical" href="https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/introduction.html" /> <meta property="og:url" content="https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/introduction.html" /> <meta property="og:site_name" content="차곡차곡 쌓자" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-04-23T00:00:00+09:00" /> <script type="application/ld+json"> {"headline":"개요 및 사용법","dateModified":"2020-04-23T00:00:00+09:00","datePublished":"2020-04-23T00:00:00+09:00","description":"차곡차곡 쌓아가는 기술블로그입니다. 되도록 정확한 자료만을 정리하려고 노력합니다.","url":"https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/introduction.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/introduction.html"},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="https://east-rain.github.io" class="site-title lh-tight"> 차곡차곡 쌓자 </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item"><a href="https://east-rain.github.io/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="https://east-rain.github.io/" class="navigation-list-link">About</a></li><li class="navigation-list-item active"><a href="https://east-rain.github.io/docs/Deep%20Learning/" class="navigation-list-link">Deep Learning</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/basic%20deeplearning/" class="navigation-list-link">딥러닝 기초</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/basic%20deeplearning/optimization.html" class="navigation-list-link">최적화 함수들(optimization)</a> </li></ul></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/" class="navigation-list-link">텐서플로우 튜토리얼</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/install_tensorflow.html" class="navigation-list-link">텐서플로우 설치 - windows</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/image_classification.html" class="navigation-list-link">텐서플로우 이미지 분류하기</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/image_transfer_learning_TFHub.html" class="navigation-list-link">텐서플로우 허브 전이학습</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/image_transfer_learning_preTrained.html" class="navigation-list-link">텐서플로우 전이학습</a> </li></ul></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/posenet/" class="navigation-list-link">PoseNet</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/posenet/introduction.html" class="navigation-list-link">개요</a> </li></ul></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/Yolo(darknet)/" class="navigation-list-link">Yolo(darknet)</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/Yolo(darknet)/introduction.html" class="navigation-list-link">개요</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/Yolo(darknet)/environment.html" class="navigation-list-link">환경설정</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/Yolo(darknet)/training.html" class="navigation-list-link">트레이닝</a> </li></ul></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/vector%20search/" class="navigation-list-link">이미지 유사도 검색</a></li><li class="navigation-list-item active"><a href="https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/" class="navigation-list-link">DeepLabCut</a><ul class="navigation-list-child-list"><li class="navigation-list-item active"> <a href="https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/introduction.html" class="navigation-list-link active">개요 및 사용법</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/deepercut.html" class="navigation-list-link">deepercut(base model)</a> </li></ul></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/Openpose/" class="navigation-list-link">Openpose</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/Openpose/openpose.html" class="navigation-list-link">개요 및 사용법</a> </li></ul></li></ul></li><li class="navigation-list-item"><a href="https://east-rain.github.io/docs/Programming/" class="navigation-list-link">Programming</a><ul class="navigation-list-child-list "></ul></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search" aria-label="Search" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <nav class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://east-rain.github.io/docs/Deep%20Learning/">Deep Learning</a></li> <li class="breadcrumb-nav-list-item"><a href="https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/">DeepLabCut</a></li> <li class="breadcrumb-nav-list-item"><span>개요 및 사용법</span></li> </ol> </nav> <div id="main-content" class="page-content" role="main"> <!-- <h1 id="deeplabcut-개요-번역">DeepLabCut 개요 번역</h1> <p><a href="http://www.mousemotorlab.org/deeplabcut">http://www.mousemotorlab.org/deeplabcut</a> <a href="https://github.com/DeepLabCut/DeepLabCut">https://github.com/DeepLabCut/DeepLabCut</a></p> <h4 id="deeplabcut--동물-포즈-추정을-위한-소프트웨어-패키지"> <a href="#deeplabcut--동물-포즈-추정을-위한-소프트웨어-패키지" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> DeepLabCut : 동물 포즈 추정을 위한 소프트웨어 패키지 </h4> <p>DeepLabCut은 3D 마커가 없는 자세 추정에 효율적인 방법을 제공한다. DeepLabCut은 멋진 결과를 달성한 <em>deep neural networks</em>에 기반한 전이학습을 가능하게 해준다. (DeepLabCut에서는 일반적으로 50~200 프레임만 있으면 최소한의 학습 데이터를 마련한 것이다). DeepLabCut은 다양한 행동에 거쳐 다양한 종들의 다양한 바디 파트를 트랙킹할 수 있다.</p> <p><img src="3mice.gif" /></p> <p>DeeperCut을 사용할 때 많은 도움을 받을 수 있는 software package이다. 기존에는 영상 프레임에서 1마리에 대한 pose estimation만을 제공하였는데 이제 multi animal pose estimation에 대한 기능을 지원해준다.</p> <hr /> <h3 id="얻을-수-있는-이점"> <a href="#얻을-수-있는-이점" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 얻을 수 있는 이점 </h3> <ol> <li>UI 또는 래핑 된 python 코드로 프로젝트 생성부터 검증, 결과 분석까지를 제공해 주기 때문에 DeeperCut 알고리즘을 이용해서 동물의 pose estimation을 할 때 상당히 편리하다.</li> <li>자체 라벨링 툴을 제공해준다.</li> <li>모델의 추론 결과를 프레임별로 검증하면서, 신체포인트를 제대로 찍지 못한 사진을 보정하고 학습을 다시 시키는 작업을 쉽게 할 수 있다.</li> <li>동물 자세 추정에 가장 적합한 data augmentation 방식을 제공해줘서 적은 사진 수로도 꽤나 정확도 높은 모델을 만들어 낼 수 있다.</li> <li>추론 결과를 다루는 다양한 함수를 제공한다. 일정 기준으로 필터링 할 수도 있고, 좌표별로 plot 그래프를 그릴 수도 있다.</li> </ol> <h3 id="사용-개요"> <a href="#사용-개요" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 사용 개요 </h2> </li> </ol> <h3 id="deeplabcut-라벨링툴을-이용하지-않는다면"> <a href="#deeplabcut-라벨링툴을-이용하지-않는다면" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Deeplabcut 라벨링툴을 이용하지 않는다면 </h3> <p>DeeplabCut은 본인의 라벨링 툴로 라벨링을 진행한다는 가정하에 사용법이 가이드 되고 있다. 하지만 나의 경우에는 효율성을 위하여 다른 라벨링 툴을 사용하였기 때문에 학습에 필요한 데이터 형식을 맞쳐주는데 상당히 까다로운 작업이 필요하다.</p> <p>DeeplabCut에 트레이닝을 위해 준비해야하는 데이터 형식은 다음과 같은 4가지 파일이다.</p> <ol> <li>csv</li> <li>h5</li> <li>pickle</li> <li>mat</li> </ol> <p><strong>아래의 코드에 본인의 custom dataset을 deeplabcut에서 사용하도록 만드는 코드가 포함되어 있다.</strong></p> <hr /> <h3 id="사용-방법"> <a href="#사용-방법" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 사용 방법 </h3> <p>먼저 밑의 코드를 이용해 프로젝트를 생성하고, 동영상 추출을 하여 config.yaml 파일을 생성하고 기본적인 데이터셋 파일들을 생성해야 한다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">deeplabcut</span>
<span class="n">deeplabcut</span><span class="p">.</span><span class="n">create_new_project</span><span class="p">(</span><span class="s">'ProjectName'</span><span class="p">,</span><span class="s">'YourName'</span><span class="p">,</span> <span class="p">[</span><span class="s">'/usr/FullPath/OfVideo1.avi'</span><span class="p">,</span> <span class="s">'/usr/FullPath/OfVideo2.avi'</span><span class="p">,</span> <span class="s">'/usr/FullPath/OfVideo1.avi'</span><span class="p">],</span>
              <span class="n">copy_videos</span><span class="o">=</span><span class="bp">True</span><span class="o">/</span><span class="bp">False</span><span class="p">,</span> <span class="n">multianimal</span><span class="o">=</span><span class="bp">True</span><span class="o">/</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <p>그리고 생성된 프로젝트 경로에 들어가서 설정파일을 변경해준다. config.yaml 파일이 설정파일이다. 읽어보면 직관적으로 다양한 설정들을 해줄 수 있으며 나의 경우에는 bodyparts와 skeleton을 내가 원하는 형태로 바꿔 주었다.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bodyparts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">eye-left</span>
<span class="pi">-</span> <span class="s">eye-right</span>
<span class="pi">-</span> <span class="s">nose</span>
<span class="pi">-</span> <span class="s">mouth-left</span>
<span class="pi">-</span> <span class="s">mouth-right</span>
<span class="pi">-</span> <span class="s">mouth-low</span>
<span class="pi">-</span> <span class="s">tongue</span>
<span class="pi">-</span> <span class="s">ear-left-start</span>
<span class="pi">-</span> <span class="s">ear-left-middle</span>
<span class="pi">-</span> <span class="s">ear-left-end</span>
<span class="pi">-</span> <span class="s">ear-right-start</span>
<span class="pi">-</span> <span class="s">ear-right-middle</span>
<span class="pi">-</span> <span class="s">ear-right-end</span>
<span class="pi">-</span> <span class="s">withers</span>
<span class="pi">-</span> <span class="s">prosternum</span>
<span class="pi">-</span> <span class="s">elbow-left</span>
<span class="pi">-</span> <span class="s">forearm-left</span>
<span class="pi">-</span> <span class="s">forefoot-left</span>
<span class="pi">-</span> <span class="s">elbow-right</span>
<span class="pi">-</span> <span class="s">forearm-right</span>
<span class="pi">-</span> <span class="s">forefoot-right</span>
<span class="pi">-</span> <span class="s">stiffle-left</span>
<span class="pi">-</span> <span class="s">hock-left</span>
<span class="pi">-</span> <span class="s">hindfoot-left</span>
<span class="pi">-</span> <span class="s">stiffle-right</span>
<span class="pi">-</span> <span class="s">hock-right</span>
<span class="pi">-</span> <span class="s">hindfoot-right</span>
<span class="pi">-</span> <span class="s">tail-start</span>
<span class="pi">-</span> <span class="s">tail-start-middle</span>
<span class="pi">-</span> <span class="s">tail-middle</span>
<span class="pi">-</span> <span class="s">tail-middle-end</span>
<span class="pi">-</span> <span class="s">tail-end</span>

<span class="na">skeleton</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">eye-right</span>
  <span class="pi">-</span> <span class="s">nose</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">eye-left</span>
  <span class="pi">-</span> <span class="s">nose</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">eye-right</span>
  <span class="pi">-</span> <span class="s">ear-right-start</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">ear-right-start</span>
  <span class="pi">-</span> <span class="s">ear-right-middle</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">ear-right-middle</span>
  <span class="pi">-</span> <span class="s">ear-right-end</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">eye-left</span>
  <span class="pi">-</span> <span class="s">ear-left-start</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">ear-left-start</span>
  <span class="pi">-</span> <span class="s">ear-left-middle</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">ear-left-middle</span>
  <span class="pi">-</span> <span class="s">ear-left-end</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">nose</span>
  <span class="pi">-</span> <span class="s">mouth-low</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">mouth-low</span>
  <span class="pi">-</span> <span class="s">mouth-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">mouth-low</span>
  <span class="pi">-</span> <span class="s">mouth-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">mouth-low</span>
  <span class="pi">-</span> <span class="s">tongue</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">nose</span>
  <span class="pi">-</span> <span class="s">withers</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">nose</span>
  <span class="pi">-</span> <span class="s">prosternum</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">withers</span>
  <span class="pi">-</span> <span class="s">elbow-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">prosternum</span>
  <span class="pi">-</span> <span class="s">elbow-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">elbow-right</span>
  <span class="pi">-</span> <span class="s">forearm-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">forearm-right</span>
  <span class="pi">-</span> <span class="s">forefoot-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">withers</span>
  <span class="pi">-</span> <span class="s">elbow-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">prosternum</span>
  <span class="pi">-</span> <span class="s">elbow-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">elbow-left</span>
  <span class="pi">-</span> <span class="s">forearm-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">forearm-left</span>
  <span class="pi">-</span> <span class="s">forefoot-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">withers</span>
  <span class="pi">-</span> <span class="s">tail-start</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">prosternum</span>
  <span class="pi">-</span> <span class="s">tail-start</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-start</span>
  <span class="pi">-</span> <span class="s">stiffle-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">stiffle-right</span>
  <span class="pi">-</span> <span class="s">hock-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">hock-right</span>
  <span class="pi">-</span> <span class="s">hindfoot-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-start</span>
  <span class="pi">-</span> <span class="s">stiffle-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">stiffle-left</span>
  <span class="pi">-</span> <span class="s">hock-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">hock-left</span>
  <span class="pi">-</span> <span class="s">hindfoot-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-start</span>
  <span class="pi">-</span> <span class="s">tail-start-middle</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-start-middle</span>
  <span class="pi">-</span> <span class="s">tail-middle</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-middle</span>
  <span class="pi">-</span> <span class="s">tail-middle-end</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-middle-end</span>
  <span class="pi">-</span> <span class="s">tail-end</span>
</code></pre></div></div> <p>config 파일을 내 입맛에 맞게 수정을 한 뒤 다음 코드를 이용해서 데이터 형식을 맞추고 트레이닝을 진행하였다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'DLClight'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"True"</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"CUDA_DEVICE_ORDER"</span><span class="p">]</span><span class="o">=</span><span class="s">"PCI_BUS_ID"</span>   
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"CUDA_VISIBLE_DEVICES"</span><span class="p">]</span><span class="o">=</span><span class="s">"0,1"</span>
<span class="kn">import</span> <span class="nn">deeplabcut</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="c1">####### 고정적인 값들 ########
</span><span class="n">scorer</span> <span class="o">=</span> <span class="s">'eastRain'</span>
<span class="n">origin_file</span> <span class="o">=</span> <span class="s">'labeled-data/origin/CollectedData_'</span> <span class="o">+</span> <span class="n">scorer</span> <span class="o">+</span> <span class="s">'_origin.h5'</span>

<span class="c1">####### 학습 시킬 때 변경해야 하는 변수들 #########
</span><span class="n">iteration_num</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="s">'/home/eastrain/mnt/test_custom_data/0519'</span>

<span class="c1">####### 자동으로 완성되는 변수들(딱히 건드릴일은 없다) ##########
</span><span class="n">iteration_name</span> <span class="o">=</span> <span class="s">'iteration-'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration_num</span><span class="p">)</span>
<span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'labeled-data'</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span><span class="s">'CollectedData_'</span> <span class="o">+</span> <span class="n">scorer</span> <span class="o">+</span> <span class="s">'.h5'</span><span class="p">)</span>
<span class="n">config_path</span> <span class="o">=</span> <span class="s">'config_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration_num</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.yaml'</span>

<span class="n">bodyparts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'eye-left'</span><span class="p">,</span>
    <span class="s">'eye-right'</span><span class="p">,</span>
    <span class="s">'nose'</span><span class="p">,</span>
    <span class="s">'mouth-left'</span><span class="p">,</span>
    <span class="s">'mouth-right'</span><span class="p">,</span>
    <span class="s">'mouth-low'</span><span class="p">,</span>
    <span class="s">'tongue'</span><span class="p">,</span>
    <span class="s">'ear-left-start'</span><span class="p">,</span>
    <span class="s">'ear-left-middle'</span><span class="p">,</span>
    <span class="s">'ear-left-end'</span><span class="p">,</span>
    <span class="s">'ear-right-start'</span><span class="p">,</span>
    <span class="s">'ear-right-middle'</span><span class="p">,</span>
    <span class="s">'ear-right-end'</span><span class="p">,</span>
    <span class="s">'withers'</span><span class="p">,</span>
    <span class="s">'prosternum'</span><span class="p">,</span>
    <span class="s">'elbow-left'</span><span class="p">,</span>
    <span class="s">'forearm-left'</span><span class="p">,</span>
    <span class="s">'forefoot-left'</span><span class="p">,</span>
    <span class="s">'elbow-right'</span><span class="p">,</span>
    <span class="s">'forearm-right'</span><span class="p">,</span>
    <span class="s">'forefoot-right'</span><span class="p">,</span>
    <span class="s">'stiffle-left'</span><span class="p">,</span>
    <span class="s">'hock-left'</span><span class="p">,</span>
    <span class="s">'hindfoot-left'</span><span class="p">,</span>
    <span class="s">'stiffle-right'</span><span class="p">,</span>
    <span class="s">'hock-right'</span><span class="p">,</span>
    <span class="s">'hindfoot-right'</span><span class="p">,</span>
    <span class="s">'tail-start'</span><span class="p">,</span>
    <span class="s">'tail-start-middle'</span><span class="p">,</span>
    <span class="s">'tail-middle'</span><span class="p">,</span>
    <span class="s">'tail-middle-end'</span><span class="p">,</span>
    <span class="s">'tail-end'</span>
<span class="p">]</span>

<span class="n">nan</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,))</span>
<span class="n">nan</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
<span class="n">dataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">origin_file</span><span class="p">,</span><span class="s">'df_with_missing'</span><span class="p">)</span>
<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">all_csv_files</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">train_data</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">file_abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_abs_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]).</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">'.csv'</span><span class="p">:</span>
            <span class="n">all_csv_files</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_abs_path</span><span class="p">))</span>

<span class="n">total_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_csv_files</span><span class="p">)</span>

<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">all_csv_files</span><span class="p">:</span>
    <span class="n">csv</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">'key'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">,</span> <span class="s">'2'</span><span class="p">,</span> <span class="s">'3'</span><span class="p">,</span> <span class="s">'4'</span><span class="p">])</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">'.'</span> <span class="o">+</span> <span class="n">csv</span><span class="p">[</span><span class="s">'key'</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">temp_df</span><span class="o">=</span><span class="bp">None</span>
    
    <span class="n">point_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">_index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv</span><span class="p">[</span><span class="s">'key'</span><span class="p">][</span><span class="mi">3</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s">'eye-left-open'</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="s">'eye-left'</span>
        <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s">'eye-right-open'</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="s">'eye-right'</span>        
        
        <span class="n">point_dict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">csv</span><span class="p">[</span><span class="s">'1'</span><span class="p">][</span><span class="mi">3</span> <span class="o">+</span> <span class="n">_index</span><span class="p">],</span> <span class="n">csv</span><span class="p">[</span><span class="s">'2'</span><span class="p">][</span><span class="mi">3</span> <span class="o">+</span> <span class="n">_index</span><span class="p">]]</span>
    
    <span class="k">for</span> <span class="n">bodypart</span> <span class="ow">in</span> <span class="n">bodyparts</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">MultiIndex</span><span class="p">.</span><span class="n">from_product</span><span class="p">([[</span><span class="n">scorer</span><span class="p">],</span> <span class="p">[</span><span class="n">bodypart</span><span class="p">],</span> <span class="p">[</span><span class="s">'x'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">]],</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">'scorer'</span><span class="p">,</span> <span class="s">'bodyparts'</span><span class="p">,</span> <span class="s">'coords'</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">bodypart</span> <span class="ow">in</span> <span class="n">point_dict</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">point_dict</span><span class="p">[</span><span class="n">bodypart</span><span class="p">]],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nan</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_name</span><span class="p">])</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">temp_df</span><span class="p">,</span> <span class="n">frame</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataFrame</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">#for _index, item in enumerate(csv['key'][3:]):
</span>    <span class="c1">#    if item == 'eye-left-open':
</span>    <span class="c1">#        item = 'eye-left'
</span>    <span class="c1">#    elif item == 'eye-right-open':
</span>    <span class="c1">#        item = 'eye-right'        
</span>    <span class="c1">#    
</span>    <span class="c1">#    dataFrame.loc[file_name][scorer, item,'x' ] = csv['1'][3 + _index]
</span>    <span class="c1">#    dataFrame.loc[file_name][scorer, item,'y' ] = csv['2'][3 + _index]
</span>        
    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">+</span> <span class="s">" / "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_cnt</span><span class="p">))</span>


<span class="n">labeled_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'labeled-data'</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">labeled_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">labeled_dir</span><span class="p">)</span>
<span class="n">labeled_file_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">labeled_dir</span><span class="p">,</span> <span class="s">'CollectedData_'</span> <span class="o">+</span> <span class="n">scorer</span><span class="p">)</span>
<span class="n">dataFrame</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">labeled_file_root</span> <span class="o">+</span> <span class="s">'.csv'</span><span class="p">)</span>
<span class="n">dataFrame</span><span class="p">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">labeled_file_root</span> <span class="o">+</span> <span class="s">'.h5'</span><span class="p">,</span> <span class="s">'df_with_missing'</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s">'table'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'w'</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">create_training_dataset</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">train_network</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">displayiters</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">saveiters</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">max_snapshots_to_keep</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">1330000</span><span class="p">,</span> <span class="n">gputouse</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div> <p>이 작업을 통해 학습을 진행하고 나면, 프로젝트 폴더의 dlc-models 밑에 수행한 iteration 폴더 밑에 스냅샷이 저장된다. 원하는 스냅샷을 사용하여 검증을 진행하면 된다. 하지만 어떤 스냅샷을 사용할지 결정을 못하였으면 <strong>Evaluation</strong>을 통하여 성능을 측정하여야 한다.</p> <p>config.yaml 파일을 열어서 <strong>snapshotindex</strong> 부분을 찾는다. 나의 경우에는 모든 스냅샷을 eval 해보고 싶어서 all 을 입력하였다. 그 뒤 다음 코드를 통해서 evaluation을 할 수 있다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">deeplabcut</span>

<span class="n">config_path</span> <span class="o">=</span> <span class="s">'config.yaml'</span>
<span class="n">deeplabcut</span><span class="p">.</span><span class="n">evaluate_network</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">plotting</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">gputouse</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <p>해당 작업을 수행하고 evaluation-results 폴더 밑으로 가보면 h5 파일과 csv 파일이 떨어져 있는 것을 확인할 수 있다. 각 이터레이션별로 Train error(px), Test error(px), p-cutoff used, Train error with p-cutoff, Test error with p-cutoff를 확인할 수 있다.</p> <hr /> <p>또한, 만들어진 모델에 video를 넣어서 output을 뽑아보거나, plot을 뽑아보는 등 다양한 작업을 할 수 있다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file_name</span> <span class="o">=</span> <span class="s">'dot_eatin'</span>
<span class="n">file_type</span> <span class="o">=</span> <span class="s">'mp4'</span>
<span class="n">iteration</span> <span class="o">=</span> <span class="s">'3'</span>
<span class="n">config_path</span> <span class="o">=</span> <span class="s">'/home/eastrain/workspace/0514/config_'</span> <span class="o">+</span> <span class="n">iteration</span> <span class="o">+</span><span class="s">'.yaml'</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'/home/eastrain/workspace/0514/output/iteration-'</span> <span class="o">+</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s">'.'</span> <span class="o">+</span> <span class="n">file_type</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">analyze_videos</span><span class="p">(</span><span class="n">config_path</span><span class="p">,[</span><span class="n">target</span><span class="p">],</span> <span class="n">videotype</span><span class="o">=</span><span class="s">'.mp4'</span><span class="p">,</span> <span class="n">save_as_csv</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">gputouse</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">filterpredictions</span><span class="p">(</span><span class="n">config_path</span><span class="p">,[</span><span class="n">target</span><span class="p">])</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">analyzeskeleton</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">videotype</span><span class="o">=</span><span class="s">'.mp4'</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">trainingsetindex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">save_as_csv</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">destfolder</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">create_labeled_video</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">filtered</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">draw_skeleton</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">plot_trajectories</span><span class="p">(</span><span class="n">config_path</span><span class="p">,[</span><span class="n">target</span><span class="p">],</span><span class="n">filtered</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">showfigures</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <hr /> <h2 id="학습을-돌리고-강아지의-자세를-추론한-영상의-일부-스크린샷과-plot-pose-결과이다"> <a href="#학습을-돌리고-강아지의-자세를-추론한-영상의-일부-스크린샷과-plot-pose-결과이다" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> 학습을 돌리고 강아지의 자세를 추론한 영상의 일부 스크린샷과 plot pose 결과이다. </h2> <p><img src="dog1.png" /> <img src="dog2.png" /> <img src="plot_filtered.png" /> <img src="trajectory_filtered.png" /></p> --> <h1 id="deeplabcut-개요-번역">DeepLabCut 개요 번역</h1> <p><a href="http://www.mousemotorlab.org/deeplabcut">http://www.mousemotorlab.org/deeplabcut</a> <a href="https://github.com/DeepLabCut/DeepLabCut">https://github.com/DeepLabCut/DeepLabCut</a></p> <h4 id="deeplabcut--동물-포즈-추정을-위한-소프트웨어-패키지">DeepLabCut : 동물 포즈 추정을 위한 소프트웨어 패키지</h4> <p>DeepLabCut은 3D 마커가 없는 자세 추정에 효율적인 방법을 제공한다. DeepLabCut은 멋진 결과를 달성한 <em>deep neural networks</em>에 기반한 전이학습을 가능하게 해준다. (DeepLabCut에서는 일반적으로 50~200 프레임만 있으면 최소한의 학습 데이터를 마련한 것이다). DeepLabCut은 다양한 행동에 거쳐 다양한 종들의 다양한 바디 파트를 트랙킹할 수 있다.</p> <p><img src="3mice.gif" /></p> <p>DeeperCut을 사용할 때 많은 도움을 받을 수 있는 software package이다. 기존에는 영상 프레임에서 1마리에 대한 pose estimation만을 제공하였는데 이제 multi animal pose estimation에 대한 기능을 지원해준다.</p> <hr /> <h3 id="얻을-수-있는-이점">얻을 수 있는 이점</h3> <ol> <li>UI 또는 래핑 된 python 코드로 프로젝트 생성부터 검증, 결과 분석까지를 제공해 주기 때문에 DeeperCut 알고리즘을 이용해서 동물의 pose estimation을 할 때 상당히 편리하다.</li> <li>자체 라벨링 툴을 제공해준다.</li> <li>모델의 추론 결과를 프레임별로 검증하면서, 신체포인트를 제대로 찍지 못한 사진을 보정하고 학습을 다시 시키는 작업을 쉽게 할 수 있다.</li> <li>동물 자세 추정에 가장 적합한 data augmentation 방식을 제공해줘서 적은 사진 수로도 꽤나 정확도 높은 모델을 만들어 낼 수 있다.</li> <li>추론 결과를 다루는 다양한 함수를 제공한다. 일정 기준으로 필터링 할 수도 있고, 좌표별로 plot 그래프를 그릴 수도 있다.</li> </ol> <h3 id="사용-개요">사용 개요</h3> <ol> <li>먼저 형상을 받고 필요한 부분들을 설치해준다. 본인이 anaconda를 이용중이라면 매우 쉽게 설치할 수 있다. 형상을 받고 conda-environments 폴더에 들어간 뒤 conda 환경을 하나 만들어준다. <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>conda env create -f DLC-GPU.yaml  # gpu 환경에서 작업 시
</code></pre></div> </div> <p>GUI 모드로 진행해도 되고 python 환경에서 deeplabcut을 import한 뒤 코드 기반으로 진행해도 된다.</p> </li> <li>프로젝트를 만들고 config파일을 원하는 방법으로 수정한다. 그 뒤 동영상을 하나 올리고 프레임을 뽑는다. 이때 프레임을 뽑는 다양한 방법을 지정할 수 있다. 그리고 자체 툴을 이용해서 라벨링을 진행한다.</li> <li>트레이닝을 할 때 사용할 backbone CNN 알고리즘을 선택한다. resnet과 mobilenet을 지원한다. 선택 후 트레이닝을 진행한다.</li> <li>트레이닝한 모델이 나오면 해당 모델에 데이터를 넣어서 추론을 한다. 그 결과를 보고 다시 라벨링 툴을 이용해 미세한 조정을 하고 다시 학습을 시킨다.</li> <li> <h2 id="그리고-이-과정을-계속-계속-반복한다">그리고 이 과정을 계속 계속 반복한다.</h2> </li> </ol> <h3 id="deeplabcut-라벨링툴을-이용하지-않는다면">Deeplabcut 라벨링툴을 이용하지 않는다면</h3> <p>DeeplabCut은 본인의 라벨링 툴로 라벨링을 진행한다는 가정하에 사용법이 가이드 되고 있다. 하지만 나의 경우에는 효율성을 위하여 다른 라벨링 툴을 사용하였기 때문에 학습에 필요한 데이터 형식을 맞쳐주는데 상당히 까다로운 작업이 필요하다.</p> <p>DeeplabCut에 트레이닝을 위해 준비해야하는 데이터 형식은 다음과 같은 4가지 파일이다.</p> <ol> <li>csv</li> <li>h5</li> <li>pickle</li> <li>mat</li> </ol> <p><strong>아래의 코드에 본인의 custom dataset을 deeplabcut에서 사용하도록 만드는 코드가 포함되어 있다.</strong></p> <hr /> <h3 id="사용-방법">사용 방법</h3> <p>먼저 밑의 코드를 이용해 프로젝트를 생성하고, 동영상 추출을 하여 config.yaml 파일을 생성하고 기본적인 데이터셋 파일들을 생성해야 한다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">deeplabcut</span>
<span class="n">deeplabcut</span><span class="p">.</span><span class="n">create_new_project</span><span class="p">(</span><span class="s">'ProjectName'</span><span class="p">,</span><span class="s">'YourName'</span><span class="p">,</span> <span class="p">[</span><span class="s">'/usr/FullPath/OfVideo1.avi'</span><span class="p">,</span> <span class="s">'/usr/FullPath/OfVideo2.avi'</span><span class="p">,</span> <span class="s">'/usr/FullPath/OfVideo1.avi'</span><span class="p">],</span>
              <span class="n">copy_videos</span><span class="o">=</span><span class="bp">True</span><span class="o">/</span><span class="bp">False</span><span class="p">,</span> <span class="n">multianimal</span><span class="o">=</span><span class="bp">True</span><span class="o">/</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div> <p>그리고 생성된 프로젝트 경로에 들어가서 설정파일을 변경해준다. config.yaml 파일이 설정파일이다. 읽어보면 직관적으로 다양한 설정들을 해줄 수 있으며 나의 경우에는 bodyparts와 skeleton을 내가 원하는 형태로 바꿔 주었다.</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">bodyparts</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">eye-left</span>
<span class="pi">-</span> <span class="s">eye-right</span>
<span class="pi">-</span> <span class="s">nose</span>
<span class="pi">-</span> <span class="s">mouth-left</span>
<span class="pi">-</span> <span class="s">mouth-right</span>
<span class="pi">-</span> <span class="s">mouth-low</span>
<span class="pi">-</span> <span class="s">tongue</span>
<span class="pi">-</span> <span class="s">ear-left-start</span>
<span class="pi">-</span> <span class="s">ear-left-middle</span>
<span class="pi">-</span> <span class="s">ear-left-end</span>
<span class="pi">-</span> <span class="s">ear-right-start</span>
<span class="pi">-</span> <span class="s">ear-right-middle</span>
<span class="pi">-</span> <span class="s">ear-right-end</span>
<span class="pi">-</span> <span class="s">withers</span>
<span class="pi">-</span> <span class="s">prosternum</span>
<span class="pi">-</span> <span class="s">elbow-left</span>
<span class="pi">-</span> <span class="s">forearm-left</span>
<span class="pi">-</span> <span class="s">forefoot-left</span>
<span class="pi">-</span> <span class="s">elbow-right</span>
<span class="pi">-</span> <span class="s">forearm-right</span>
<span class="pi">-</span> <span class="s">forefoot-right</span>
<span class="pi">-</span> <span class="s">stiffle-left</span>
<span class="pi">-</span> <span class="s">hock-left</span>
<span class="pi">-</span> <span class="s">hindfoot-left</span>
<span class="pi">-</span> <span class="s">stiffle-right</span>
<span class="pi">-</span> <span class="s">hock-right</span>
<span class="pi">-</span> <span class="s">hindfoot-right</span>
<span class="pi">-</span> <span class="s">tail-start</span>
<span class="pi">-</span> <span class="s">tail-start-middle</span>
<span class="pi">-</span> <span class="s">tail-middle</span>
<span class="pi">-</span> <span class="s">tail-middle-end</span>
<span class="pi">-</span> <span class="s">tail-end</span>

<span class="na">skeleton</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">eye-right</span>
  <span class="pi">-</span> <span class="s">nose</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">eye-left</span>
  <span class="pi">-</span> <span class="s">nose</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">eye-right</span>
  <span class="pi">-</span> <span class="s">ear-right-start</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">ear-right-start</span>
  <span class="pi">-</span> <span class="s">ear-right-middle</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">ear-right-middle</span>
  <span class="pi">-</span> <span class="s">ear-right-end</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">eye-left</span>
  <span class="pi">-</span> <span class="s">ear-left-start</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">ear-left-start</span>
  <span class="pi">-</span> <span class="s">ear-left-middle</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">ear-left-middle</span>
  <span class="pi">-</span> <span class="s">ear-left-end</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">nose</span>
  <span class="pi">-</span> <span class="s">mouth-low</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">mouth-low</span>
  <span class="pi">-</span> <span class="s">mouth-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">mouth-low</span>
  <span class="pi">-</span> <span class="s">mouth-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">mouth-low</span>
  <span class="pi">-</span> <span class="s">tongue</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">nose</span>
  <span class="pi">-</span> <span class="s">withers</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">nose</span>
  <span class="pi">-</span> <span class="s">prosternum</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">withers</span>
  <span class="pi">-</span> <span class="s">elbow-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">prosternum</span>
  <span class="pi">-</span> <span class="s">elbow-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">elbow-right</span>
  <span class="pi">-</span> <span class="s">forearm-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">forearm-right</span>
  <span class="pi">-</span> <span class="s">forefoot-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">withers</span>
  <span class="pi">-</span> <span class="s">elbow-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">prosternum</span>
  <span class="pi">-</span> <span class="s">elbow-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">elbow-left</span>
  <span class="pi">-</span> <span class="s">forearm-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">forearm-left</span>
  <span class="pi">-</span> <span class="s">forefoot-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">withers</span>
  <span class="pi">-</span> <span class="s">tail-start</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">prosternum</span>
  <span class="pi">-</span> <span class="s">tail-start</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-start</span>
  <span class="pi">-</span> <span class="s">stiffle-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">stiffle-right</span>
  <span class="pi">-</span> <span class="s">hock-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">hock-right</span>
  <span class="pi">-</span> <span class="s">hindfoot-right</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-start</span>
  <span class="pi">-</span> <span class="s">stiffle-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">stiffle-left</span>
  <span class="pi">-</span> <span class="s">hock-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">hock-left</span>
  <span class="pi">-</span> <span class="s">hindfoot-left</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-start</span>
  <span class="pi">-</span> <span class="s">tail-start-middle</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-start-middle</span>
  <span class="pi">-</span> <span class="s">tail-middle</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-middle</span>
  <span class="pi">-</span> <span class="s">tail-middle-end</span>
<span class="pi">-</span> <span class="pi">-</span> <span class="s">tail-middle-end</span>
  <span class="pi">-</span> <span class="s">tail-end</span>
</code></pre></div></div> <p>config 파일을 내 입맛에 맞게 수정을 한 뒤 다음 코드를 이용해서 데이터 형식을 맞추고 트레이닝을 진행하였다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'DLClight'</span><span class="p">]</span> <span class="o">=</span> <span class="s">"True"</span>
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"CUDA_DEVICE_ORDER"</span><span class="p">]</span><span class="o">=</span><span class="s">"PCI_BUS_ID"</span>   
<span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">"CUDA_VISIBLE_DEVICES"</span><span class="p">]</span><span class="o">=</span><span class="s">"0,1"</span>
<span class="kn">import</span> <span class="nn">deeplabcut</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="c1">####### 고정적인 값들 ########
</span><span class="n">scorer</span> <span class="o">=</span> <span class="s">'eastRain'</span>
<span class="n">origin_file</span> <span class="o">=</span> <span class="s">'labeled-data/origin/CollectedData_'</span> <span class="o">+</span> <span class="n">scorer</span> <span class="o">+</span> <span class="s">'_origin.h5'</span>

<span class="c1">####### 학습 시킬 때 변경해야 하는 변수들 #########
</span><span class="n">iteration_num</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="s">'/home/eastrain/mnt/test_custom_data/0519'</span>

<span class="c1">####### 자동으로 완성되는 변수들(딱히 건드릴일은 없다) ##########
</span><span class="n">iteration_name</span> <span class="o">=</span> <span class="s">'iteration-'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration_num</span><span class="p">)</span>
<span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'labeled-data'</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">,</span><span class="s">'CollectedData_'</span> <span class="o">+</span> <span class="n">scorer</span> <span class="o">+</span> <span class="s">'.h5'</span><span class="p">)</span>
<span class="n">config_path</span> <span class="o">=</span> <span class="s">'config_'</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration_num</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.yaml'</span>

<span class="n">bodyparts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'eye-left'</span><span class="p">,</span>
    <span class="s">'eye-right'</span><span class="p">,</span>
    <span class="s">'nose'</span><span class="p">,</span>
    <span class="s">'mouth-left'</span><span class="p">,</span>
    <span class="s">'mouth-right'</span><span class="p">,</span>
    <span class="s">'mouth-low'</span><span class="p">,</span>
    <span class="s">'tongue'</span><span class="p">,</span>
    <span class="s">'ear-left-start'</span><span class="p">,</span>
    <span class="s">'ear-left-middle'</span><span class="p">,</span>
    <span class="s">'ear-left-end'</span><span class="p">,</span>
    <span class="s">'ear-right-start'</span><span class="p">,</span>
    <span class="s">'ear-right-middle'</span><span class="p">,</span>
    <span class="s">'ear-right-end'</span><span class="p">,</span>
    <span class="s">'withers'</span><span class="p">,</span>
    <span class="s">'prosternum'</span><span class="p">,</span>
    <span class="s">'elbow-left'</span><span class="p">,</span>
    <span class="s">'forearm-left'</span><span class="p">,</span>
    <span class="s">'forefoot-left'</span><span class="p">,</span>
    <span class="s">'elbow-right'</span><span class="p">,</span>
    <span class="s">'forearm-right'</span><span class="p">,</span>
    <span class="s">'forefoot-right'</span><span class="p">,</span>
    <span class="s">'stiffle-left'</span><span class="p">,</span>
    <span class="s">'hock-left'</span><span class="p">,</span>
    <span class="s">'hindfoot-left'</span><span class="p">,</span>
    <span class="s">'stiffle-right'</span><span class="p">,</span>
    <span class="s">'hock-right'</span><span class="p">,</span>
    <span class="s">'hindfoot-right'</span><span class="p">,</span>
    <span class="s">'tail-start'</span><span class="p">,</span>
    <span class="s">'tail-start-middle'</span><span class="p">,</span>
    <span class="s">'tail-middle'</span><span class="p">,</span>
    <span class="s">'tail-middle-end'</span><span class="p">,</span>
    <span class="s">'tail-end'</span>
<span class="p">]</span>

<span class="n">nan</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,))</span>
<span class="n">nan</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span>
<span class="n">dataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">origin_file</span><span class="p">,</span><span class="s">'df_with_missing'</span><span class="p">)</span>
<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">all_csv_files</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">files</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">train_data</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">file_abs_path</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_abs_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]).</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">'.csv'</span><span class="p">:</span>
            <span class="n">all_csv_files</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file_abs_path</span><span class="p">))</span>

<span class="n">total_cnt</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_csv_files</span><span class="p">)</span>

<span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">all_csv_files</span><span class="p">:</span>
    <span class="n">csv</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">'key'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">,</span> <span class="s">'2'</span><span class="p">,</span> <span class="s">'3'</span><span class="p">,</span> <span class="s">'4'</span><span class="p">])</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s">'.'</span> <span class="o">+</span> <span class="n">csv</span><span class="p">[</span><span class="s">'key'</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">temp_df</span><span class="o">=</span><span class="bp">None</span>
    
    <span class="n">point_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">_index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">csv</span><span class="p">[</span><span class="s">'key'</span><span class="p">][</span><span class="mi">3</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s">'eye-left-open'</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="s">'eye-left'</span>
        <span class="k">elif</span> <span class="n">item</span> <span class="o">==</span> <span class="s">'eye-right-open'</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="s">'eye-right'</span>        
        
        <span class="n">point_dict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">csv</span><span class="p">[</span><span class="s">'1'</span><span class="p">][</span><span class="mi">3</span> <span class="o">+</span> <span class="n">_index</span><span class="p">],</span> <span class="n">csv</span><span class="p">[</span><span class="s">'2'</span><span class="p">][</span><span class="mi">3</span> <span class="o">+</span> <span class="n">_index</span><span class="p">]]</span>
    
    <span class="k">for</span> <span class="n">bodypart</span> <span class="ow">in</span> <span class="n">bodyparts</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">MultiIndex</span><span class="p">.</span><span class="n">from_product</span><span class="p">([[</span><span class="n">scorer</span><span class="p">],</span> <span class="p">[</span><span class="n">bodypart</span><span class="p">],</span> <span class="p">[</span><span class="s">'x'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">]],</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">'scorer'</span><span class="p">,</span> <span class="s">'bodyparts'</span><span class="p">,</span> <span class="s">'coords'</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">bodypart</span> <span class="ow">in</span> <span class="n">point_dict</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">point_dict</span><span class="p">[</span><span class="n">bodypart</span><span class="p">]],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">nan</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">file_name</span><span class="p">])</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">temp_df</span><span class="p">,</span> <span class="n">frame</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">dataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataFrame</span><span class="p">,</span> <span class="n">temp_df</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">#for _index, item in enumerate(csv['key'][3:]):
</span>    <span class="c1">#    if item == 'eye-left-open':
</span>    <span class="c1">#        item = 'eye-left'
</span>    <span class="c1">#    elif item == 'eye-right-open':
</span>    <span class="c1">#        item = 'eye-right'        
</span>    <span class="c1">#    
</span>    <span class="c1">#    dataFrame.loc[file_name][scorer, item,'x' ] = csv['1'][3 + _index]
</span>    <span class="c1">#    dataFrame.loc[file_name][scorer, item,'y' ] = csv['2'][3 + _index]
</span>        
    <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">+</span> <span class="s">" / "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_cnt</span><span class="p">))</span>


<span class="n">labeled_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'labeled-data'</span><span class="p">,</span> <span class="n">iteration_name</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">labeled_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">labeled_dir</span><span class="p">)</span>
<span class="n">labeled_file_root</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">labeled_dir</span><span class="p">,</span> <span class="s">'CollectedData_'</span> <span class="o">+</span> <span class="n">scorer</span><span class="p">)</span>
<span class="n">dataFrame</span><span class="p">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">labeled_file_root</span> <span class="o">+</span> <span class="s">'.csv'</span><span class="p">)</span>
<span class="n">dataFrame</span><span class="p">.</span><span class="n">to_hdf</span><span class="p">(</span><span class="n">labeled_file_root</span> <span class="o">+</span> <span class="s">'.h5'</span><span class="p">,</span> <span class="s">'df_with_missing'</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s">'table'</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'w'</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">create_training_dataset</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">train_network</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">displayiters</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">saveiters</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">max_snapshots_to_keep</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">1330000</span><span class="p">,</span> <span class="n">gputouse</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div> <p>이 작업을 통해 학습을 진행하고 나면, 프로젝트 폴더의 dlc-models 밑에 수행한 iteration 폴더 밑에 스냅샷이 저장된다. 원하는 스냅샷을 사용하여 검증을 진행하면 된다. 하지만 어떤 스냅샷을 사용할지 결정을 못하였으면 <strong>Evaluation</strong>을 통하여 성능을 측정하여야 한다.</p> <p>config.yaml 파일을 열어서 <strong>snapshotindex</strong> 부분을 찾는다. 나의 경우에는 모든 스냅샷을 eval 해보고 싶어서 all 을 입력하였다. 그 뒤 다음 코드를 통해서 evaluation을 할 수 있다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">deeplabcut</span>

<span class="n">config_path</span> <span class="o">=</span> <span class="s">'config.yaml'</span>
<span class="n">deeplabcut</span><span class="p">.</span><span class="n">evaluate_network</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="n">plotting</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">gputouse</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <p>해당 작업을 수행하고 evaluation-results 폴더 밑으로 가보면 h5 파일과 csv 파일이 떨어져 있는 것을 확인할 수 있다. 각 이터레이션별로 Train error(px), Test error(px), p-cutoff used, Train error with p-cutoff, Test error with p-cutoff를 확인할 수 있다.</p> <hr /> <p>또한, 만들어진 모델에 video를 넣어서 output을 뽑아보거나, plot을 뽑아보는 등 다양한 작업을 할 수 있다.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file_name</span> <span class="o">=</span> <span class="s">'dot_eatin'</span>
<span class="n">file_type</span> <span class="o">=</span> <span class="s">'mp4'</span>
<span class="n">iteration</span> <span class="o">=</span> <span class="s">'3'</span>
<span class="n">config_path</span> <span class="o">=</span> <span class="s">'/home/eastrain/workspace/0514/config_'</span> <span class="o">+</span> <span class="n">iteration</span> <span class="o">+</span><span class="s">'.yaml'</span>
<span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">'/home/eastrain/workspace/0514/output/iteration-'</span> <span class="o">+</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s">'.'</span> <span class="o">+</span> <span class="n">file_type</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">analyze_videos</span><span class="p">(</span><span class="n">config_path</span><span class="p">,[</span><span class="n">target</span><span class="p">],</span> <span class="n">videotype</span><span class="o">=</span><span class="s">'.mp4'</span><span class="p">,</span> <span class="n">save_as_csv</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">gputouse</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">filterpredictions</span><span class="p">(</span><span class="n">config_path</span><span class="p">,[</span><span class="n">target</span><span class="p">])</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">analyzeskeleton</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">videotype</span><span class="o">=</span><span class="s">'.mp4'</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">trainingsetindex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">save_as_csv</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">destfolder</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">create_labeled_video</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="p">[</span><span class="n">target</span><span class="p">],</span> <span class="n">filtered</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">draw_skeleton</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

<span class="n">deeplabcut</span><span class="p">.</span><span class="n">plot_trajectories</span><span class="p">(</span><span class="n">config_path</span><span class="p">,[</span><span class="n">target</span><span class="p">],</span><span class="n">filtered</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">showfigures</span><span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <hr /> <h2 id="학습을-돌리고-강아지의-자세를-추론한-영상의-일부-스크린샷과-plot-pose-결과이다">학습을 돌리고 강아지의 자세를 추론한 영상의 일부 스크린샷과 plot pose 결과이다.</h2> <p><img src="dog1.png" /> <img src="dog2.png" /> <img src="plot_filtered.png" /> <img src="trajectory_filtered.png" /></p> </div> </div> </div> </div> </body> </html>
