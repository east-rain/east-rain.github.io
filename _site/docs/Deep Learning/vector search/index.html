<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>이미지 유사도 검색 - 차곡차곡 쌓자</title> <link rel="shortcut icon" href="https://east-rain.github.io/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="https://east-rain.github.io/assets/css/just-the-docs.css"> <link rel="alternate" type="application/rss+xml" href="https://east-rain.github.io/feed.xml" title="차곡차곡 쌓자 Feed"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163902491-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', "UA-163902491-1"); </script> <script type="text/javascript" src="https://east-rain.github.io/assets/js/vendor/lunr.min.js" charset="utf-8"></script> <script type="text/javascript" src="https://east-rain.github.io/assets/js/just-the-docs.js" charset="utf-8"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <meta name="naver-site-verification" content="0ec4078b2caa70b3c1bd0053083cb7b3ed281f42" /> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>이미지 유사도 검색 | 차곡차곡 쌓자</title> <meta name="generator" content="Jekyll v3.8.6" /> <meta property="og:title" content="이미지 유사도 검색" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="차곡차곡 쌓아가는 기술블로그입니다. 되도록 정확한 자료만을 정리하려고 노력합니다." /> <meta property="og:description" content="차곡차곡 쌓아가는 기술블로그입니다. 되도록 정확한 자료만을 정리하려고 노력합니다." /> <link rel="canonical" href="https://east-rain.github.io/docs/Deep%20Learning/vector%20search/" /> <meta property="og:url" content="https://east-rain.github.io/docs/Deep%20Learning/vector%20search/" /> <meta property="og:site_name" content="차곡차곡 쌓자" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2020-10-28T00:00:00+09:00" /> <script type="application/ld+json"> {"headline":"이미지 유사도 검색","dateModified":"2020-10-28T00:00:00+09:00","datePublished":"2020-10-28T00:00:00+09:00","description":"차곡차곡 쌓아가는 기술블로그입니다. 되도록 정확한 자료만을 정리하려고 노력합니다.","url":"https://east-rain.github.io/docs/Deep%20Learning/vector%20search/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://east-rain.github.io/docs/Deep%20Learning/vector%20search/"},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="https://east-rain.github.io" class="site-title lh-tight"> 차곡차곡 쌓자 </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item active"><a href="https://east-rain.github.io/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="https://east-rain.github.io/" class="navigation-list-link">About</a></li><li class="navigation-list-item active"><a href="https://east-rain.github.io/docs/Deep%20Learning/" class="navigation-list-link">Deep Learning</a><ul class="navigation-list-child-list "><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/basic%20deeplearning/" class="navigation-list-link">딥러닝 기초</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/basic%20deeplearning/optimization.html" class="navigation-list-link">최적화 함수들(optimization)</a> </li></ul></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/" class="navigation-list-link">텐서플로우 튜토리얼</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/install_tensorflow.html" class="navigation-list-link">텐서플로우 설치 - windows</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/image_classification.html" class="navigation-list-link">텐서플로우 이미지 분류하기</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/image_transfer_learning_TFHub.html" class="navigation-list-link">텐서플로우 허브 전이학습</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/tensorflow%20tutorial/image_transfer_learning_preTrained.html" class="navigation-list-link">텐서플로우 전이학습</a> </li></ul></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/posenet/" class="navigation-list-link">PoseNet</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/posenet/introduction.html" class="navigation-list-link">개요</a> </li></ul></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/Yolo(darknet)/" class="navigation-list-link">Yolo(darknet)</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/Yolo(darknet)/introduction.html" class="navigation-list-link">개요</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/Yolo(darknet)/environment.html" class="navigation-list-link">환경설정</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/Yolo(darknet)/training.html" class="navigation-list-link">트레이닝</a> </li></ul></li><li class="navigation-list-item active"><a href="https://east-rain.github.io/docs/Deep%20Learning/vector%20search/" class="navigation-list-link active">이미지 유사도 검색</a></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/Openpose/" class="navigation-list-link">Openpose</a></li><li class="navigation-list-item "><a href="https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/" class="navigation-list-link">DeepLabCut</a><ul class="navigation-list-child-list"><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/introduction.html" class="navigation-list-link">개요</a> </li><li class="navigation-list-item "> <a href="https://east-rain.github.io/docs/Deep%20Learning/deeplabcut/deepercut.html" class="navigation-list-link">deepercut(base model)</a> </li></ul></li></ul></li><li class="navigation-list-item"><a href="https://east-rain.github.io/docs/Programming/" class="navigation-list-link">Programming</a><ul class="navigation-list-child-list "></ul></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search" aria-label="Search" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <nav class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="https://east-rain.github.io/docs/Deep%20Learning/">Deep Learning</a></li> <li class="breadcrumb-nav-list-item"><span>이미지 유사도 검색</span></li> </ol> </nav> <div id="main-content" class="page-content" role="main"> <!-- <p>https://github.com/facebookresearch/faiss.git</p> <p>facebook에서 공개한 Faiss를 이용하여 이미지 유사도를 검색하였다.</p> <h3 id="faiss란"> <a href="#faiss란" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Faiss란? </h3> <p>Faiss는 밀도가 높은 벡터의 효율적인 유사성 검색 및 클러스터링을위한 라이브러리입니다. 여기에는 RAM에 맞지 않을 수있는 최대 크기의 벡터 세트에서 검색하는 알고리즘이 포함되어 있습니다. 평가 및 매개 변수 조정을위한 지원 코드도 포함되어 있습니다. Python / numpy를 위한 완전한 래퍼와 함께 C ++로 작성되었습니다. 가장 유용한 알고리즘 중 일부는 GPU에서 구현됩니다. Facebook AI Research에서 개발했습니다.</p> <p>다양한 백터 유사도 검색 알고리즘들을 구현해놓고 쓰기 쉽게 말아 놓았다. 그 중에서 HNSW(Hierarchical Navigable Small World graphs)를 이용해서 이미지 유사도를 검색하였다.</p> <p>백터 그래프를 그리는 코드는 다음과 같다</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">import</span> <span class="n">struct</span>
<span class="n">import</span> <span class="n">glob</span>
<span class="n">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">import</span> <span class="n">os</span>
<span class="n">import</span> <span class="n">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="k">from</span> <span class="n">tensorflow</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">mobilenet_v2</span> <span class="n">import</span> <span class="n">preprocess_input</span>
<span class="n">import</span> <span class="n">tensorflow</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span> <span class="k">as</span> <span class="n">layers</span>
<span class="k">from</span> <span class="n">tensorflow</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">models</span> <span class="n">import</span> <span class="k">Model</span>

<span class="n">def</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
    <span class="n">img</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">img</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">channels</span><span class="p">=</span><span class="n">input_shape</span><span class="p">[</span><span class="m">2</span><span class="p">])</span>
    <span class="n">img</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">[:</span><span class="m">2</span><span class="p">])</span>
    <span class="n">img</span> <span class="p">=</span> <span class="n">preprocess_input</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">return</span> <span class="n">img</span>

<span class="n">def</span> <span class="n">main</span><span class="p">():</span>
    <span class="n">batch_size</span> <span class="p">=</span> <span class="m">100</span>
    <span class="n">input_shape</span> <span class="p">=</span> <span class="p">(</span><span class="m">224</span><span class="p">,</span> <span class="m">224</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
    <span class="n">base</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">MobileNetV2</span><span class="p">(</span><span class="n">input_shape</span><span class="p">=</span><span class="n">input_shape</span><span class="p">,</span>
                                             <span class="n">include_top</span><span class="p">=</span><span class="nb">False</span><span class="p">,</span>
                                             <span class="n">weights</span><span class="p">=</span><span class="s1">'imagenet'</span><span class="p">)</span>
    <span class="n">base</span><span class="p">.</span><span class="n">trainable</span> <span class="p">=</span> <span class="nb">False</span>
    <span class="k">model</span> <span class="p">=</span> <span class="k">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">=</span><span class="n">base</span><span class="p">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="p">=</span><span class="n">layers</span><span class="p">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">base</span><span class="p">.</span><span class="n">output</span><span class="p">))</span>


    <span class="n">root_dir</span> <span class="p">=</span> <span class="s2">"이미지 존재하는 루트 디렉토리"</span>
    <span class="n">images</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="n">for</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="k">in</span> <span class="n">os</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
        <span class="n">for</span> <span class="n">filename</span> <span class="k">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">".png"</span> <span class="k">in</span> <span class="n">filename</span> <span class="k">or</span> <span class="s2">".jpg"</span> <span class="k">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">images</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dirpath</span> <span class="p">+</span> <span class="s2">"/"</span> <span class="p">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">fnames</span> <span class="p">=</span> <span class="n">images</span>

    <span class="n">list_ds</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
    <span class="n">ds</span> <span class="p">=</span> <span class="n">list_ds</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">),</span> <span class="n">num_parallel_calls</span><span class="p">=-</span><span class="m">1</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="p">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">).</span><span class="n">prefetch</span><span class="p">(-</span><span class="m">1</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">open</span><span class="p">(</span><span class="s1">'fvecs.bin'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">for</span> <span class="n">batch</span> <span class="k">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">fvecs</span> <span class="p">=</span> <span class="k">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="n">fmt</span> <span class="p">=</span> <span class="n">f</span><span class="s1">'{np.prod(fvecs.shape)}f'</span>
            <span class="n">f</span><span class="p">.</span><span class="nb">write</span><span class="p">(</span><span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="p">*(</span><span class="n">fvecs</span><span class="p">.</span><span class="n">flatten</span><span class="p">())))</span>

    <span class="k">with</span> <span class="n">open</span><span class="p">(</span><span class="s1">'fnames.txt'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="nb">write</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">fnames</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="p">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div> <p>해당 코드를 통해 백터 그래프를 그리면 다음과 같이 3개의 파일이 생성된다. fnames.txt, fvecs.bin, fvecs.bin.hnsw.index</p> <p>그리고 이제 이 파일들을 이용해서 유사도를 검색할 수 있다.</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import os
import time
import math
import random
import numpy as np
import json
from sklearn.preprocessing import normalize
import faiss
import csv


def dist2sim(d):
    return 1 - d / 2
    

def get_index(index_type, dim):
    if index_type == 'hnsw':
        m = 48
        index = faiss.IndexHNSWFlat(dim, m)
        index.hnsw.efConstruction = 128
        return index
    elif index_type == 'l2':
        return faiss.IndexFlatL2(dim)
    raise


def populate(index, fvecs, batch_size=1000):
    nloop = math.ceil(fvecs.shape[0] / batch_size)
    for n in range(nloop):
        s = time.time()
        index.add(normalize(fvecs[n * batch_size : min((n + 1) * batch_size, fvecs.shape[0])]))
        print(n * batch_size, time.time() - s)

    return index


def find_file_name(idx):
	if idx == -1:
		return 'None'
	with open('fnames.txt', 'r') as f:
		names = f.readlines()
	return names[idx].strip('\n').strip('\t')

def main():
    dim = 1280
    fvec_file = 'fvecs.bin'
    index_type = 'hnsw'
    #index_type = 'l2'

	# f-string 방식 (python3 이상에서 지원)
    index_file = f'{fvec_file}.{index_type}.index'

    fvecs = np.memmap(fvec_file, dtype='float32', mode='r').view('float32').reshape(-1, dim)

    if os.path.exists(index_file):
        index = faiss.read_index(index_file)
        if index_type == 'hnsw':
            index.hnsw.efSearch = 256
    else:
        index = get_index(index_type, dim)
        index = populate(index, fvecs)
        faiss.write_index(index, index_file)
    print(index.ntotal)

    random.seed(2020)
    
	# random하게 쿼리 인덱스를 생성한다
    # 0부터 데이터 갯수 사이의 인덱스
    q_idx = [random.randint(0, fvecs.shape[0]) for _ in range(100)]
    q_idx = np.arange(0, 1)
    k = 10
    s = time.time()
    
    total = 0
    csv_file = open('result.csv', 'w', encoding='utf-8-sig', newline='')
    wr = csv.writer(csv_file)
    for source in range(index.ntotal):
    	q_idx = [source]
    	dists, idxs = index.search(normalize(fvecs[q_idx]), k)
    	sim_files = []
    	sim_scores = []
    	for i, idx in enumerate(idxs[0]):
    		if dists[0][i] &lt;= 0.3 and idx != source:
    			sim_scores.append(dists[0][i])
    			sim_files.append(find_file_name(idx))
    			total = total + 1

    	if len(sim_files) &gt; 0:
    		wr.writerow([find_file_name(source)])
    		for i, file in enumerate(sim_files):
    			wr.writerow([sim_scores[i], file])

    print("length = " + str(len(sim_files)))
    csv_file.close()
    print(total)
  
if __name__ == '__main__':
    main()
</code></pre></div></div> <p>해당 코드를 돌리면 fnames.txt에 존재하는 모든 파일들을 읽어와서 백터 유사도 검색을 해서 이미지의 유사도를 result.csv파일에 모두 뛀궈준다.</p> <p>그리고 그래프를 그리고 찾는 두개의 코드를 이용해 실시간으로 이미지의 유사도를 검색할 수 있는 시스템을 구성할 수도 있다.</p> <p><img src="similary.png" /></p> --> <p>https://github.com/facebookresearch/faiss.git</p> <p>facebook에서 공개한 Faiss를 이용하여 이미지 유사도를 검색하였다.</p> <h3 id="faiss란">Faiss란?</h3> <p>Faiss는 밀도가 높은 벡터의 효율적인 유사성 검색 및 클러스터링을위한 라이브러리입니다. 여기에는 RAM에 맞지 않을 수있는 최대 크기의 벡터 세트에서 검색하는 알고리즘이 포함되어 있습니다. 평가 및 매개 변수 조정을위한 지원 코드도 포함되어 있습니다. Python / numpy를 위한 완전한 래퍼와 함께 C ++로 작성되었습니다. 가장 유용한 알고리즘 중 일부는 GPU에서 구현됩니다. Facebook AI Research에서 개발했습니다.</p> <p>다양한 백터 유사도 검색 알고리즘들을 구현해놓고 쓰기 쉽게 말아 놓았다. 그 중에서 HNSW(Hierarchical Navigable Small World graphs)를 이용해서 이미지 유사도를 검색하였다.</p> <p>백터 그래프를 그리는 코드는 다음과 같다</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">import</span> <span class="n">struct</span>
<span class="n">import</span> <span class="n">glob</span>
<span class="n">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="n">import</span> <span class="n">os</span>
<span class="n">import</span> <span class="n">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="k">from</span> <span class="n">tensorflow</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">mobilenet_v2</span> <span class="n">import</span> <span class="n">preprocess_input</span>
<span class="n">import</span> <span class="n">tensorflow</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span> <span class="k">as</span> <span class="n">layers</span>
<span class="k">from</span> <span class="n">tensorflow</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">models</span> <span class="n">import</span> <span class="k">Model</span>

<span class="n">def</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
    <span class="n">img</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
    <span class="n">img</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">channels</span><span class="p">=</span><span class="n">input_shape</span><span class="p">[</span><span class="m">2</span><span class="p">])</span>
    <span class="n">img</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">[:</span><span class="m">2</span><span class="p">])</span>
    <span class="n">img</span> <span class="p">=</span> <span class="n">preprocess_input</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">return</span> <span class="n">img</span>

<span class="n">def</span> <span class="n">main</span><span class="p">():</span>
    <span class="n">batch_size</span> <span class="p">=</span> <span class="m">100</span>
    <span class="n">input_shape</span> <span class="p">=</span> <span class="p">(</span><span class="m">224</span><span class="p">,</span> <span class="m">224</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
    <span class="n">base</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">MobileNetV2</span><span class="p">(</span><span class="n">input_shape</span><span class="p">=</span><span class="n">input_shape</span><span class="p">,</span>
                                             <span class="n">include_top</span><span class="p">=</span><span class="nb">False</span><span class="p">,</span>
                                             <span class="n">weights</span><span class="p">=</span><span class="s1">'imagenet'</span><span class="p">)</span>
    <span class="n">base</span><span class="p">.</span><span class="n">trainable</span> <span class="p">=</span> <span class="nb">False</span>
    <span class="k">model</span> <span class="p">=</span> <span class="k">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">=</span><span class="n">base</span><span class="p">.</span><span class="n">input</span><span class="p">,</span> <span class="n">outputs</span><span class="p">=</span><span class="n">layers</span><span class="p">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()(</span><span class="n">base</span><span class="p">.</span><span class="n">output</span><span class="p">))</span>


    <span class="n">root_dir</span> <span class="p">=</span> <span class="s2">"이미지 존재하는 루트 디렉토리"</span>
    <span class="n">images</span> <span class="p">=</span> <span class="p">[]</span>
    <span class="n">for</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="k">in</span> <span class="n">os</span><span class="p">.</span><span class="n">walk</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
        <span class="n">for</span> <span class="n">filename</span> <span class="k">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">".png"</span> <span class="k">in</span> <span class="n">filename</span> <span class="k">or</span> <span class="s2">".jpg"</span> <span class="k">in</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">images</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">dirpath</span> <span class="p">+</span> <span class="s2">"/"</span> <span class="p">+</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">fnames</span> <span class="p">=</span> <span class="n">images</span>

    <span class="n">list_ds</span> <span class="p">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">fnames</span><span class="p">)</span>
    <span class="n">ds</span> <span class="p">=</span> <span class="n">list_ds</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">),</span> <span class="n">num_parallel_calls</span><span class="p">=-</span><span class="m">1</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="p">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">).</span><span class="n">prefetch</span><span class="p">(-</span><span class="m">1</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">open</span><span class="p">(</span><span class="s1">'fvecs.bin'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">for</span> <span class="n">batch</span> <span class="k">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">fvecs</span> <span class="p">=</span> <span class="k">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="n">fmt</span> <span class="p">=</span> <span class="n">f</span><span class="s1">'{np.prod(fvecs.shape)}f'</span>
            <span class="n">f</span><span class="p">.</span><span class="nb">write</span><span class="p">(</span><span class="n">struct</span><span class="p">.</span><span class="n">pack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="p">*(</span><span class="n">fvecs</span><span class="p">.</span><span class="n">flatten</span><span class="p">())))</span>

    <span class="k">with</span> <span class="n">open</span><span class="p">(</span><span class="s1">'fnames.txt'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">.</span><span class="nb">write</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">fnames</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="p">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></div> <p>해당 코드를 통해 백터 그래프를 그리면 다음과 같이 3개의 파일이 생성된다. fnames.txt, fvecs.bin, fvecs.bin.hnsw.index</p> <p>그리고 이제 이 파일들을 이용해서 유사도를 검색할 수 있다.</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import os
import time
import math
import random
import numpy as np
import json
from sklearn.preprocessing import normalize
import faiss
import csv


def dist2sim(d):
    return 1 - d / 2
    

def get_index(index_type, dim):
    if index_type == 'hnsw':
        m = 48
        index = faiss.IndexHNSWFlat(dim, m)
        index.hnsw.efConstruction = 128
        return index
    elif index_type == 'l2':
        return faiss.IndexFlatL2(dim)
    raise


def populate(index, fvecs, batch_size=1000):
    nloop = math.ceil(fvecs.shape[0] / batch_size)
    for n in range(nloop):
        s = time.time()
        index.add(normalize(fvecs[n * batch_size : min((n + 1) * batch_size, fvecs.shape[0])]))
        print(n * batch_size, time.time() - s)

    return index


def find_file_name(idx):
	if idx == -1:
		return 'None'
	with open('fnames.txt', 'r') as f:
		names = f.readlines()
	return names[idx].strip('\n').strip('\t')

def main():
    dim = 1280
    fvec_file = 'fvecs.bin'
    index_type = 'hnsw'
    #index_type = 'l2'

	# f-string 방식 (python3 이상에서 지원)
    index_file = f'{fvec_file}.{index_type}.index'

    fvecs = np.memmap(fvec_file, dtype='float32', mode='r').view('float32').reshape(-1, dim)

    if os.path.exists(index_file):
        index = faiss.read_index(index_file)
        if index_type == 'hnsw':
            index.hnsw.efSearch = 256
    else:
        index = get_index(index_type, dim)
        index = populate(index, fvecs)
        faiss.write_index(index, index_file)
    print(index.ntotal)

    random.seed(2020)
    
	# random하게 쿼리 인덱스를 생성한다
    # 0부터 데이터 갯수 사이의 인덱스
    q_idx = [random.randint(0, fvecs.shape[0]) for _ in range(100)]
    q_idx = np.arange(0, 1)
    k = 10
    s = time.time()
    
    total = 0
    csv_file = open('result.csv', 'w', encoding='utf-8-sig', newline='')
    wr = csv.writer(csv_file)
    for source in range(index.ntotal):
    	q_idx = [source]
    	dists, idxs = index.search(normalize(fvecs[q_idx]), k)
    	sim_files = []
    	sim_scores = []
    	for i, idx in enumerate(idxs[0]):
    		if dists[0][i] &lt;= 0.3 and idx != source:
    			sim_scores.append(dists[0][i])
    			sim_files.append(find_file_name(idx))
    			total = total + 1

    	if len(sim_files) &gt; 0:
    		wr.writerow([find_file_name(source)])
    		for i, file in enumerate(sim_files):
    			wr.writerow([sim_scores[i], file])

    print("length = " + str(len(sim_files)))
    csv_file.close()
    print(total)
  
if __name__ == '__main__':
    main()
</code></pre></div></div> <p>해당 코드를 돌리면 fnames.txt에 존재하는 모든 파일들을 읽어와서 백터 유사도 검색을 해서 이미지의 유사도를 result.csv파일에 모두 뛀궈준다.</p> <p>그리고 그래프를 그리고 찾는 두개의 코드를 이용해 실시간으로 이미지의 유사도를 검색할 수 있는 시스템을 구성할 수도 있다.</p> <p><img src="similary.png" /></p> </div> </div> </div> </div> </body> </html>
